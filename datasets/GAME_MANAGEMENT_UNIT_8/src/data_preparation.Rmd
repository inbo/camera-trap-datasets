---
title: "Prepare Agouti project GMU8 (Camtrap DP) for publication on GBIF"
author: 
- Sanne Govaert
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Load libraries

```{r prep packages}
library(here)
library(camtrapdp)
library(dplyr) 
library(lubridate)
library(EML)
library(zip)
```

## Read data

```{r camtrap data}
name_exportfolder <- "gmu8-monitoring-faunabeheerzone-8-20250515135034"
file <- here::here("datasets", "GAME_MANAGEMENT_UNIT_8", "data", "raw", name_exportfolder, "datapackage.json")
data <- camtrapdp::read_camtrapdp(file)
```

# Get data ready for publication

## Data

### Geospatial coordinates are rounded to 0.001 degrees

```{r round coordinates}
rounded_data <-
  data %>% 
  camtrapdp::round_coordinates(digits = 2)
```

### Set embargo

Set an embargo on the last year. Before this date, all data is public. After this date, only observations of exotic species are kept.

```{r}
today <- Sys.Date()
embargo_date <- today %m-% months(12)
exotic_species <- c("Muntiacus reevesi", "Procyon lotor", "Aix galericulata", "Cervus nippon", "Dama dama")
embargo_data <- 
  rounded_data %>% 
  camtrapdp::filter_observations(
    eventStart <= embargo_date
    |
    scientificName %in% exotic_species
  )
```

Check which species are maintained after the embargo data:

```{r}
embargo_data %>%
  camtrapdp::filter_observations(eventStart >= embargo_date) %>% 
  camtrapdp::taxa()
```


### Privacy settings

Hide the media of dogs for privacy reasons.

```{r remove media of dogs}
mediaID_dogs <- embargo_data %>% 
  camtrapdp::filter_observations(scientificName %in% c("Canis lupus familiaris")) %>% 
  camtrapdp::media() %>% 
  dplyr::pull(mediaID)

camtrapdp::media(embargo_data) <-
  rounded_data %>%
  camtrapdp::media() %>%
  dplyr::mutate(
    filePath = dplyr::if_else(
      mediaID %in% mediaID_dogs,
      "private",
      filePath,
      missing = filePath
    ),
    filePublic = dplyr::if_else(
      mediaID %in% mediaID_dogs,
      FALSE,
      filePublic,
      missing = filePublic
    )
  )
```

## Make GBIF-proof

GBIF does not accept negative values in bounding box values, so set negative values to NA.

```{r}
gmu8 <- embargo_data
camtrapdp::observations(gmu8) <- 
  camtrapdp::observations(gmu8) %>%
  dplyr::mutate(
    bboxX = dplyr::if_else(.data$bboxX < 0, NA, bboxX),
    bboxY = dplyr::if_else(.data$bboxY < 0, NA, bboxY)
    )
```
 

## Metadata

Add:

- title
- license
- abstract (description)
- keywords
- references
- project path

Adjust:

- contributors
- image url

```{r add metadata}
# Basic metadata
gmu8$title <- "GMU8 - Camera trap observations in natural habitats south of Leuven (Belgium)" 

gmu8$licenses <- list(
  list(
    scope = "data", 
    name = "CC0-1.0", 
    path = "https://creativecommons.org/publicdomain/zero/1.0/"
    ), 
  list(
    scope = "media",
    name = "CC-BY-4.0",
    path = "http://creativecommons.org/licenses/by/4.0/"
    )
  )

gmu8$description <- NULL

gmu8$contributors <- NULL

# Fix mistake in image url
gmu8$image <- "https://api.agouti.eu/uploads/project-images/20180430144018-IMG_0612.JPG"

# Keywords
gmu8$keywords <- c("camera traps", "alien species", "Flanders, Belgium", "Mammalia", "birds", "Lifewatch", "invasive alien species", "European observatory of wildlife","Nationaal Park Brabantse Wouden")

# References
gmu8$references <- NULL

# Add project path
#gmu8$project$path <- "https://agouti.eu/#/explore/project/91e1e104-a296-461e-af79-eeb6cb3e6c7f"
# Uncommment the line above if your project is allowed to be visible on the public homepage and portal of Agouti (need to be checked off in the settings)
```


# Write Camera Trap Data Package

```{r write camtrap DP}
dir_processed <- here::here("datasets",  "GAME_MANAGEMENT_UNIT_8", "data", "processed")
camtrapdp::write_camtrapdp(gmu8, dir_processed)

# Zip these files
zipfile <-  paste0(dir_processed, "/datapackage.zip")
files2zip <- c(
  "datapackage.json",
  "deployments.csv",
  "media.csv",
  "observations.csv"
)
zip::zip(zipfile, files = files2zip, root = dir_processed)
```

