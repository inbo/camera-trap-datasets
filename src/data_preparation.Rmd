---
title: "Clean and filter muntjac dataset"
author: 
- Bram D'hondt
- Sanne Govaert
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

### Load libraries

```{r prep packages}
library(here)
library(camtrapdp)
library(dplyr) 
library(lubridate)
library(EML)
```

### Read data

```{r camtrap data}
name_exportfolder <- "muntjak-vlaanderen-20240606110007"
file <- here::here("data", "raw", name_exportfolder, "datapackage.json")
raw_data <- camtrapdp::read_camtrapdp(file)
```

# 1. Notes on cameras and solutions

## 1.1 To do: issue that still need a fix

### VOR15b -- 2023-04-06 -- 2023-05-12

Issue: This sequence is from a muntjac, not a calibration. 

YET TO BE CORRECTED, in Agouti, as soon as possible (24-05-16 still not possible).

```{r issue VOR15b -- 2023-04-06 -- 2023-05-12}
camtrapdp::deployments(raw_data) %>%
  dplyr::filter(deploymentID == "0427b248-2e3d-4028-b3ce-dc8f5aefbe0c") %>% 
  dplyr::select(deploymentID, locationName, deploymentStart, deploymentEnd)
```

## 1.2 Issues without fix (accept as they are)

### 1.2.1 Defects

Cannot be remedied. Accepted as a methodological limitation.

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2021-11 -- 2022-01 | Prematurely failed.
VOR18b | 2022-12 -- 2023-01 | Defective. No sequence obtained.
VOR21b | 2022-12 -- 2023-01 | Defective. No sequence obtained.
PEE01 | 2023-11 -- 2024-01 | Defective. No sequence obtained.
PEE16 | 2024-01 -- 2024-02 | Defective. No sequence obtained.
INS07 | 2024-02 -- 2024-04 | Prematurely failed.
INS12 | 2024-02 -- 2024-04 | Defective. No sequence obtained.
VOR06b | 2024-04-05 -- 2024-04-25 | No camera was installed (none available).
VOR20b | 2024-04 -- 2024-05 | Prematurely failed.
VOR22b | 2024-04 -- 2024-05 | Prematurely failed.
INS12 | 2024-04 -- 2024-05 | Prematurely failed.
INS14 | 2024-04 -- 2024-05 | Prematurely failed.

### 1.2.2 Slight image abnormalities

Issue: the position of the camera was slightly shifted compared to the previous or subsequent deployment. Ignored. Accepted as noise

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2022-01 -- 2022-02 | Temporary branch for the camera.
VOR16a | 2022-02 -- 2022-03 | Temporary branch for the camera.
VOR16a | 2022-05 -- 2022-05 | Slight shift.
VOR17a | 2021 -- 2022 | Slight shifts throughout the deployment.

### 1.2.3 Other issues

Location | Time range | Issue | Conclusion
-------- | ---------- | ----- | ----------
VOR16a | 2021-11-29 -- 2021-12-13 | Each image became a single sequence, and the series also stopped abruptly. | Ignored. Accepted as noise. The end date of the deployment reflects the premature stop.
VOR15a -- VOR18a | 2021 - 2011 | Not set up to take a photo at noon and midnight. | No action required.
BHN13 | 2022-05-03 -- 2022-05-31 | (1) image not identical to deployments before the storm; (2) image not stable during deployment. | Ignored. Accepted as noise.
VOR18a | 2022-05-03 -- 2022-05-31 | Failed prematurely on 2022-05-07. | No action required.
INS11 | 2024-04 -- 2024-05 | Problematic in various aspects. (1) Set to daylight saving time instead of standard time (but the correction has already been made in Agouti); (2) Sequence creation is incorrect (sequences of 10 are often split). | Marked as 'invalid' in Agouti. Could theoretically be cleaned up (time-consuming).

## 1.3 Inaccurate data that can be fixed

```{r rename data}
clean_data <- raw_data
```

### 1.3.1 Fix missassigned observations

Issue: 5 observations have been assigned to the wrong deployment. They belong to VOR08a instead of BHN12.

```{r show missassigned observations}
misassigned <- 
  clean_data %>%
  camtrapdp::filter_observations(observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"") 

misassigned %>% 
  camtrapdp::observations() %>% 
  dplyr::select(eventID, deploymentID, observationComments, eventEnd)
```

```{r fix missassigned observations}
correct_depID <- "38214914-4c0f-485c-91e7-d080d4c5cd0e"

# Correct deploymentID in observations and update observationComment
camtrapdp::observations(clean_data) <-
  camtrapdp::observations(clean_data) %>%
  dplyr::mutate(
    deploymentID = ifelse(
      observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"",
      correct_depID,
      deploymentID
    ),
    observationComments = ifelse(
      observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"",
      NA,
      observationComments
    )
  )

# Extract eventIDs of media related to misassigned observations
eventID_misassigned <-
  misassigned %>% 
  camtrapdp::media() %>% 
  dplyr::pull(eventID) %>% 
  unique()

# Correct deploymentID in these media
camtrapdp::media(clean_data) <-
  camtrapdp::media(clean_data) %>% 
  dplyr::mutate(
    deploymentID = ifelse(
      eventID %in% eventID_misassigned,
      correct_depID,
      deploymentID
    )
  )

# Inspect fix
camtrapdp::observations(clean_data) %>%
  dplyr::filter(eventID %in% eventID_misassigned) %>% 
  dplyr::select(eventID, deploymentID, observationComments)

camtrapdp::media(clean_data) %>% 
  dplyr::filter(eventID %in% eventID_misassigned) %>% 
  dplyr::select(eventID, deploymentID)
```

### 1.3.2 Correct deploymentEnd

Issue: BHN13 is damaged in a storm on 2022-02-18-17-31. But it initially continued to operate.

DeploymentEnd is adjusted, and observations and related media after this time are removed.

```{r fix BHN13 -- 2022-02--2022-03}
deploymentID_storm <- "f27bd070-d28c-45f0-a888-5b97835bf796"
new_deploymentEnd <- as.POSIXct("2022-02-18 17:31:00", tz = "Europe/Brussels")

# Mutate deploymentEnd
camtrapdp::deployments(clean_data) <-
  camtrapdp::deployments(clean_data) %>%
  dplyr::mutate(
    deploymentEnd =
      as.POSIXct(
        ifelse(
          deploymentID == deploymentID_storm,
          new_deploymentEnd,
          deploymentEnd
        )
      )
  )

# Update observations and media
clean_data <-
  clean_data %>%
  camtrapdp::filter_observations(eventEnd <= new_deploymentEnd)

# Update metadata
clean_data <- camtrapdp:::update_temporal(clean_data)
```

```{r check fix BHN13 -- 2022-02--2022-03}
# Inspect deployment
camtrapdp::deployments(clean_data) %>%
  dplyr::filter(deploymentID == deploymentID_storm) %>%
  dplyr::select(deploymentID, deploymentStart, deploymentEnd)

# Inspect observations
camtrapdp::observations(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(last_eventEnd = max(eventEnd))

# Inspect media
camtrapdp::media(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(last_timestamp = max(timestamp))

# Inspect metadata
clean_data$temporal
```

### 1.3.3 Correct time

1) Issue: incorrect time setting throughout the deployment of VOR23b -- 2022--2023. Retroactively determined, it must have been installed at approximately "2022-12-05 13:40:00" (+ 11.87361 hours) during the initial setup.

```{r fix VOR23b -- 2022--2023}
current <- "2022-12-05 01:47:35"
new <- "2022-12-05 13:40:00"
deployment_ids <- c(
  "8de6a0a1-9308-4d99-8a71-e2a2c710739d",
  "c8008e80-3684-4ee0-a491-0e11a7d55918",
  "83784cd8-107a-4219-82bd-05da22d7abf1",
  "96dc5829-22e9-4532-ba0f-0d891e74051a"
)

duration <- lubridate::as.duration(lubridate::interval(current, new))
purrr::map(deployment_ids, ~ {
  clean_data <<- clean_data %>%
    camtrapdp::shift_time(
      deployment_id = .x,
      duration = duration_PEE11
    )
})
```

2) Issue: incorrect time setting throughout the deployment of PEE11=INS05 -- 2023--2024. Retroactively determined, it must have been installed at approximately "2023-11-21 11:44:00" during the initial setup.

```{r fix PEE11-INS05 -- 2023--2024}
current <- "2023-11-22 00:04:41"
new <- "2023-11-21 11:44:00"
deployment_ids <- c(
  "e6f5df99-30a8-4969-b432-eaf88d1d780e",
  "9c94441d-dc0b-4e83-bdee-d4b847b6f003",
  "71e601db-fbfe-4468-8e40-6cd0d2047a2a",
  "6acb2575-65f7-411d-b5b1-a8b466127a43"
  )

duration <- lubridate::as.duration(lubridate::interval(current, new))
purrr::map(deployment_ids, ~ {
  clean_data <<- clean_data %>%
    camtrapdp::shift_time(
      deployment_id = .x,
      duration = duration_PEE11
    )
})
```

## 1.4 Inaccurate data that need to be removed

DeploymentID | LocationName | Time range | Issue
-- | -- | -- | --
"7a85b0ea-6ed8-4d1e-801f-78082cb660ec" | BHN12 | 2022-02--2022-03 | The position of the camera has shifted significantly. It is now pointing mostly upwards, which is problematic.
"91ae688c-818c-4e74-8c02-8bc2f8c842be" | VOR08b | 2023-11--2024-01 | A large branch fell in front of the camera; it was there from 2023-11-27 to 2024-01-10. This is almost the entire sequence, so it would be easiest to remove it completely.
"72633b07-b39c-4827-ae35-ffcc1cb02607 | VOR06b | 2024-02--2024-04 | Although there were recordings up until the last readout, the clock has stopped since 2024-03-14. Problematic. Pros and cons. â†’ It would be wisest to remove it completely (?)

Remove these deployments:

```{r remove deployments}
deploymentID_to_remove <- c(
  "7a85b0ea-6ed8-4d1e-801f-78082cb660ec",
  "91ae688c-818c-4e74-8c02-8bc2f8c842be",
  "72633b07-b39c-4827-ae35-ffcc1cb02607"
)

clean_data <-
  clean_data %>% 
  camtrapdp::filter_deployments(!deploymentID %in% deploymentID_to_remove)
```

# 2. Get data ready for publication

## 2.1 Data

### 2.1.1 Geospatial coordinates are rounded to 0.001 degrees

```{r round coordinates}
rounded_data <-
  clean_data %>% 
  camtrapdp::round_coordinates(digits = 3)
```
### 2.1.2 Privacy settings

Exclude the media of dogs for privacy reasons, but keep the observations.

```{r remove media of dogs}
mediaID_dogs <- rounded_data %>% 
  camtrapdp::filter_observations(scientificName %in% c("Canis lupus familiaris", "Canis lupus")) %>% 
  camtrapdp::media() %>% 
  dplyr::pull(mediaID)


camtrapdp::media(rounded_data) <-
  rounded_data %>% 
  camtrapdp::media() %>% 
  dplyr::filter(!mediaID %in% mediaID_dogs)
```

To do: Correct 'canis lupus' to 'canis lupus familiaris' (preferably upstream in Agouti, obs per obs :-/)

## 2.2 Metadata

Add:
- title
- license
- abstract (description)
- keywords

Adjust:
- contributors

```{r add metadata}
muntjac <- rounded_data

# Basic metadata
muntjac$title <- "AGOUTI_MUNTJAC_OCCURRENCES - Camera trap observations of Chinese muntjac in forested areas near Antwerp (Belgium)"

muntjac$licenses <- list(
  list(name = "CC0-1.0", scope = "data"), 
  list(path = "http://creativecommons.org/licenses/by/4.0/", scope = "media")
  )

muntjac$description <- c(
  "<![CDATA[ This camera trap dataset is derived from INBOâ€™s <a href=\"https://www.agouti.eu/\">Agouti</a> project on the monitoring of Chinese muntjac (<i>Muntiacus reevesi</i>). ]]>",
  "This is an occurrence dataset published by the Research Institute of Nature and Forest (INBO). It is part of a project to monitor muntjac in the Region of Flanders with respect to Regulation EU nr. 1143/2014. The monitoring is performed in close collaboration with the Agency for Nature and Forests (ANB).",
  "Issues with the dataset can be reported at <a href=\"https://github.com/inbo/mica-occurrences/issues\">https://github.com/inbo/mica-occurrences/issues</a>",
  "We have released this dataset to the public domain under a Creative Commons Zero waiver. We would appreciate it if you follow the INBO norms for data use (<a href=\"https://www.inbo.be/en/norms-data-use\">https://www.inbo.be/en/norms-data-use</a>) when using the data. If you have any questions regarding this dataset, don't hesitate to contact us via the contact information provided in the metadata or via opendata@inbo.be.",
  "This dataset was collected using infrastructure managed by INBO and financed by the Research Foundation - Flanders (FWO) as part of the Belgian contribution to LifeWatch."
)

muntjac$contributors <-
  list(
    list(
      title = "Bram D'hondt",
      email = "bram.dhondt@inbo.be",
      path = "https://orcid.org/0000-0002-1330-1457",
      role = "principalInvestigator",
      organization = "Research Institute for Nature and Forest (INBO)"
    ),
    list(
      title = "Jim Casaer",
      email = "jim.casaer@inbo.be",
      path = "https://orcid.org/0000-0001-6788-5876",
      role = "principalInvestigator",
      organization = "Research Institute for Nature and Forest (INBO)"
    ),
    list(
      title = "Jan Vercammen",
      email = "jan.vercammen@inbo.be",
      role = "principalInvestigator",
      organization = "Research Institute for Nature and Forest (INBO)"
    ),
    list(
      title = "Lynn Pallemaerts",
      email = "lynn.pallemaerts@inbo.be",
      path = "https://orcid.org/0000-0002-5034-5416",
      role = "contributor",
      organization = "Research Institute for Nature and Forest (INBO)"
    ),
    list(
      title = "Tim Adriaens",
      email = "tim.adriaens@inbo.be",
      path = "https://orcid.org/0000-0001-7268-4200",
      role = "contributor",
      organization = "Research Institute for Nature and Forest (INBO)"
    ),
    list(
      title = "Peter Desmet",
      email = "peter.desmet@inbo.be",
      path = "https://orcid.org/0000-0002-8442-8025",
      role = "principalInvestigator",
      organization = "Research Institute for Nature and Forest (INBO)"
    ),
    list(
      title = "Sanne Govaert",
      email = "sanne.govaert@inbo.be",
      path = "https://orcid.org/0000-0002-8939-1305",
      role = "principalInvestigator",
      organization = "Research Institute for Nature and Forest (INBO)"
    )
  )

# Keywords
muntjac$keywords <- c("camera traps", "alien species", "Flanders, Belgium", "Mammalia", "birds", "Lifewatch", "Chinese muntjac", "Muntiacus reevesi", "invasive alien species")
# Project data - Project Personnel - remove
```

# 3. Transform to a Darwin Core Archive
```{r write dwc}
camtrapdp::write_dwc(muntjac, here::here("data", "processed", name_exportfolder))
```

# 4. Write and transform EML
```{r write EML}
eml <- camtrapdp::write_eml(muntjac, here::here("data", "processed", name_exportfolder), derived_paragraph = TRUE)
```

Add:
- geographic description
- taxonomic description
- metadata provider

```{r update EML}
eml$dataset$coverage$geographicCoverage$geographicDescription <- "Forest areas east of Antwerp, Flanders (Belgium)."
eml$dataset$coverage$taxonomicCoverage$generalTaxonomicCoverage <- "<![CDATA[ The target species for this dataset is Chinese muntjac (<i>Muntiacus reevesi</i>), but other species of mammals and birds have been observed as well. ]]>"

eml$dataset$metadataProvider <- EML::set_responsibleParty(
  givenName = "Sanne",
  surName = "Govaert",
  organizationName = "Research Institute for Nature and Forest (INBO)",
  electronicMailAddress = "sanne.govaert@inbo.be",
  onlineUrl = "https://orcid.org/",
  userId = "0000-0002-8939-1305"
)
```

Write EML again.

```{r overwrite EML}
EML::write_eml(eml, here::here("data", "processed", name_exportfolder, "eml.xml"))
```

