---
title: "Clean and filter muntjac dataset"
author: 
- Bram D'hondt
- Sanne Govaert
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

### Load libraries

```{r prep packages}
library(here)
library(camtrapdp)
library(dplyr) 
library(lubridate)
```

### Read data

```{r camtrap data}
name_exportfolder <- "muntjak-vlaanderen-20240606110007"
file <- here::here("data", "raw", name_exportfolder, "datapackage.json")
raw_data <- camtrapdp::read_camtrapdp(file)
```

# 1. Notes on cameras and solutions

## 1.1 To do: issue that still need a fix

### VOR15b -- 2023-04-06 -- 2023-05-12

Issue: This sequence is from a muntjac, not a calibration. 

YET TO BE CORRECTED, in Agouti, as soon as possible (24-05-16 still not possible).

```{r}
camtrapdp::deployments(raw_data) %>%
  dplyr::filter(deploymentID == "0427b248-2e3d-4028-b3ce-dc8f5aefbe0c") %>% 
  dplyr::select(deploymentID, locationName, deploymentStart, deploymentEnd)
```

## 1.2 Issues without fix (accept as they are)

### 1.2.1 Defects

Cannot be remedied. Accepted as a methodological limitation.

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2021-11 -- 2022-01 | Prematurely failed.
VOR18b | 2022-12 -- 2023-01 | Defective. No sequence obtained.
VOR21b | 2022-12 -- 2023-01 | Defective. No sequence obtained.
PEE01 | 2023-11 -- 2024-01 | Defective. No sequence obtained.
PEE16 | 2024-01 -- 2024-02 | Defective. No sequence obtained.
INS07 | 2024-02 -- 2024-04 | Prematurely failed.
INS12 | 2024-02 -- 2024-04 | Defective. No sequence obtained.
VOR06b | 2024-04-05 -- 2024-04-25 | No camera was installed (none available).
VOR20b | 2024-04 -- 2024-05 | Prematurely failed.
VOR22b | 2024-04 -- 2024-05 | Prematurely failed.
INS12 | 2024-04 -- 2024-05 | Prematurely failed.
INS14 | 2024-04 -- 2024-05 | Prematurely failed.

### 1.2.2 Slight image abnormalities

Issue: the position of the camera was slightly shifted compared to the previous or subsequent deployment. Ignored. Accepted as noise

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2022-01 -- 2022-02 | Temporary branch for the camera.
VOR16a | 2022-02 -- 2022-03 | Temporary branch for the camera.
VOR16a | 2022-05 -- 2022-05 | Slight shift.
VOR17a | 2021 -- 2022 | Slight shifts throughout the deployment.

### 1.2.3 Other issues

Location | Time range | Issue | Conclusion
-------- | ---------- | ----- | ----------
VOR16a | 2021-11-29 -- 2021-12-13 | Each image became a single sequence, and the series also stopped abruptly. | Ignored. Accepted as noise. The end date of the deployment reflects the premature stop.
VOR15a -- VOR18a | 2021 - 2011 | Not set up to take a photo at noon and midnight. | No action required.
BHN13 | 2022-05-03 -- 2022-05-31 | (1) image not identical to deployments before the storm; (2) image not stable during deployment. | Ignored. Accepted as noise.
VOR18a | 2022-05-03 -- 2022-05-31 | Failed prematurely on 2022-05-07. | No action required.
INS11 | 2024-04 -- 2024-05 | Problematic in various aspects. (1) Set to daylight saving time instead of standard time (but the correction has already been made in Agouti); (2) Sequence creation is incorrect (sequences of 10 are often split). | Marked as 'invalid' in Agouti. Could theoretically be cleaned up (time-consuming).

## 1.3 Inaccurate data that can be fixed

```{r}
clean_data <- raw_data
```

### 1.3.1 Fix missassigned observations

Issue: 5 observations have been assigned to the wrong deployment. They belong to VOR08a instead of BHN12.

```{r show missassigned observations}
misassigned <- 
  clean_data %>%
  camtrapdp::filter_observations(observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"") 

misassigned %>% 
  camtrapdp::observations() %>% 
  dplyr::select(eventID, deploymentID, observationComments, eventEnd)
```

```{r fix missassigned observations}
correct_depID <- "38214914-4c0f-485c-91e7-d080d4c5cd0e"

# Correct deploymentID in observations and update observationComment
camtrapdp::observations(clean_data) <-
  camtrapdp::observations(clean_data) %>%
  dplyr::mutate(
    deploymentID = ifelse(
      observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"",
      correct_depID,
      deploymentID
    ),
    observationComments = ifelse(
      observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"",
      "",
      observationComments
    )
  )

# Extract eventIDs of media related to misassigned observations
eventID_misassigned <-
  misassigned %>% 
  camtrapdp::media() %>% 
  dplyr::pull(eventID) %>% 
  unique()

# Correct deploymentID in these media
camtrapdp::media(clean_data) <-
  camtrapdp::media(clean_data) %>% 
  dplyr::mutate(
    deploymentID = ifelse(
      eventID %in% eventID_misassigned,
      correct_depID,
      deploymentID
    )
  )

# Inspect fix
camtrapdp::observations(clean_data) %>%
  dplyr::filter(eventID %in% eventID_misassigned) %>% 
  dplyr::select(eventID, deploymentID, observationComments)

camtrapdp::media(clean_data) %>% 
  dplyr::filter(eventID %in% eventID_misassigned) %>% 
  dplyr::select(eventID, deploymentID)
```

### 1.3.2 Correct deploymentEnd

Issue: BHN13 is damaged in a storm on 2022-02-18-17-31. But it initially continued to operate.

DeploymentEnd is adjusted, and observations and related media after this time are removed.

```{r fix BHN13 -- 2022-02--2022-03}
deploymentID_storm <- "f27bd070-d28c-45f0-a888-5b97835bf796"
new_deploymentEnd <- as.POSIXct("2022-02-18 17:31:00", tz = "Europe/Brussels")

# Mutate deploymentEnd
camtrapdp::deployments(clean_data) <-
  camtrapdp::deployments(clean_data) %>%
  dplyr::mutate(
    deploymentEnd =
      as.POSIXct(
        ifelse(
          deploymentID == deploymentID_storm,
          new_deploymentEnd,
          deploymentEnd
        )
      )
  )

# Update observations and media
clean_data <-
  clean_data %>%
  camtrapdp::filter_observations(eventEnd <= new_deploymentEnd)

# Update metadata
clean_data <- camtrapdp:::update_temporal(clean_data)
```

```{r check fix BHN13 -- 2022-02--2022-03}
# Inspect deployment
camtrapdp::deployments(clean_data) %>%
  dplyr::filter(deploymentID == deploymentID_storm) %>%
  dplyr::select(deploymentID, deploymentStart, deploymentEnd)

# Inspect observations
camtrapdp::observations(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(last_eventEnd = max(eventEnd))

# Inspect media
camtrapdp::media(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(last_timestamp = max(timestamp))

# Inspect metadata
clean_data$temporal
```

### 1.3.3 Correct time

1) Issue: incorrect time setting throughout the deployment of VOR23b -- 2022--2023. Retroactively determined, it must have been installed at approximately "2022-12-05 13:40:00" (+ 11.87361 hours) during the initial setup.

```{r fix VOR23b -- 2022--2023}
wrong_time = "2022-12-05 01:47:35"
right_time = "2022-12-05 13:40:00"
duration = lubridate::as.duration(lubridate::interval(wrong_time, right_time))

clean_data <-
  clean_data %>%
  camtrapdp::shift_time(
    deployment_id = "8de6a0a1-9308-4d99-8a71-e2a2c710739d",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "c8008e80-3684-4ee0-a491-0e11a7d55918",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "83784cd8-107a-4219-82bd-05da22d7abf1",
    duration = duration
    ) %>%
  camtrapdp::shift_time(
    deployment_id = "96dc5829-22e9-4532-ba0f-0d891e74051a",
    duration = duration
    )
```

2) Issue: incorrect time setting throughout the deployment of PEE11=INS05 -- 2023--2024. Retroactively determined, it must have been installed at approximately "2023-11-21 11:44:00" during the initial setup.

```{r fix PEE11-INS05 -- 2023--2024}
wrong = "2023-11-22 00:04:41"
right = "2023-11-21 11:44:00"

clean_data <-
  clean_data %>%
  camtrapdp::shift_time(
    deployment_id = "e6f5df99-30a8-4969-b432-eaf88d1d780e",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "9c94441d-dc0b-4e83-bdee-d4b847b6f003",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "71e601db-fbfe-4468-8e40-6cd0d2047a2a",
    duration = duration
    ) %>%
  camtrapdp::shift_time(
    deployment_id = "6acb2575-65f7-411d-b5b1-a8b466127a43",
    duration = duration)
```

## 1.4 Inaccurate data that need to be removed

Overview: 

DeploymentID | LocationName | Time range | Issue
-- | -- | -- | --
"7a85b0ea-6ed8-4d1e-801f-78082cb660ec" | BHN12 | 2022-02--2022-03 | The position of the camera has shifted significantly. It is now pointing mostly upwards, which is problematic.
"91ae688c-818c-4e74-8c02-8bc2f8c842be" | VOR08b | 2023-11--2024-01 | A large branch fell in front of the camera; it was there from 2023-11-27 to 2024-01-10. This is almost the entire sequence, so it would be easiest to remove it completely.
"72633b07-b39c-4827-ae35-ffcc1cb02607 | VOR06b | 2024-02--2024-04 | Although there were recordings up until the last readout, the clock has stopped since 2024-03-14. Problematic. Pros and cons. â†’ It would be wisest to remove it completely (?)

### 1.4.1 Remove deployments

```{r remove deployments}
deploymentID_to_remove <- c(
  "7a85b0ea-6ed8-4d1e-801f-78082cb660ec",
  "91ae688c-818c-4e74-8c02-8bc2f8c842be",
  "72633b07-b39c-4827-ae35-ffcc1cb02607"
)

clean_data <-
  clean_data %>% 
  camtrapdp::filter_deployments(!deploymentID %in% deploymentID_to_remove)
```

# 2. Filtering data

The data should only include observations (and associated media) of animals. Excluded are records that document blank or unclassified media, vehicles and observations of humans. Geospatial coordinates are rounded to 0.001 degrees.

```{r}
# inspection
clean_data %>% 
  camtrapdp::deployments() %>% 
  dplyr::select(latitude, longitude)
clean_data %>%
  camtrapdp::observations() %>% 
  dplyr::select(observationType) %>% 
  unique()

# filtering and rounding
rounded_data <-
  clean_data %>% 
  camtrapdp::round_coordinates(digits = 3)

# check
rounded_data %>% 
  camtrapdp::deployments() %>% 
  dplyr::select(latitude, longitude)
```


Exclude dogs (or: include observations but exclude media)
```{r}
rounded_data %>% 
  camtrapdp::filter_observations(scientificName == "Canis lupus familiaris") %>% 
  camtrapdp::media()
```

Correct 'canis lupus' to 'canis lupus familiaris' (preferably upstream in Agouti, obs per obs :-/)

# 3. Transform to a Darwin Core Archive

```{r}
camtrapdp::write_dwc(rounded_data, here("data", "processed", name_exportfolder))
```