---
title: "Clean and filter muntjac dataset"
author: 
- Bram D'hondt
- Sanne Govaert
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r prep packages}
library(here)
library(camtraptor)
library(camtrapdp)
library(dplyr) 
library(lubridate)
```

```{r camtrap data}
name_exportfolder <- "muntjak-vlaanderen-20240606110007"
file <- here::here("data", "raw", name_exportfolder, "datapackage.json")
raw_data <- camtrapdp::read_camtrapdp(file)
```

# Notes on cameras and solutions

## To do: issue that still need a fix

### VOR15b -- 2023-04-06 -- 2023-05-12

Issue: deze sequentie is een muntjak, geen kalibratie. In Agouti dd24-04 kan correctie niet worden gemaakt.

```{r}
seqID <- "f111b060-61cb-4e1f-b47b-e5fab4c3123f" # @Bram is this correct?

deployments(raw_data) %>%
  dplyr::filter(deploymentID == "0427b248-2e3d-4028-b3ce-dc8f5aefbe0c") %>% 
  dplyr::select(deploymentID, locationName, deploymentStart, deploymentEnd)
```

NOG TE CORRIGEREN, in Agouti, van zodra mogelijk (dd24-05-16 nog steeds niet).

## Issues without fix (accept as they are)

### Defects

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2021-11 -- 2022-01 | Vroegtijdig uitgevallen.
VOR18b | 2022-12 -- 2023-01 | Defect. Geen reeks bekomen.
VOR21b | 2022-12 -- 2023-01 | Defect. Geen reeks bekomen.
PEE01 | 2023-11 -- 2024-01 | Defect. Geen reeks bekomen.
PEE16 | 2024-01 -- 2024-02 | Defect. Geen reeks bekomen.
INS07 | 2024-02 -- 2024-04 | Vroegtijdig uitgevallen.
INS12 | 2024-02 -- 2024-04 | Defect. Geen reeks bekomen.
VOR06b | 2024-04-05 -- 2024-04-25 | Geen camera gehangen (geen voorhanden).
VOR20b | 2024-04 -- 2024-05 | Vroegtijdig uitgevallen.
VOR22b | 2024-04 -- 2024-05 | Vroegtijdig uitgevallen.
INS12 | 2024-04 -- 2024-05 | Vroegtijdig uitgevallen.
INS14 | 2024-04 -- 2024-05 | Vroegtijdig uitgevallen.

Niet te verhelpen. Aanvaard als methodologische beperking.


### Slight image abnormalities

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2022-01 -- 2022-02 | Tijdelijk tak voor camera.
VOR16a | 2022-02 -- 2022-03 | Tijdelijk tak voor camera.
VOR16a | 2022-05 -- 2022-05 | Lichte verschuiving.
VOR17a | 2021 -- 2022 | Lichte verschuivingen doorheen campagne.

Issue: positie van camera licht verschoven vergeleken met voorgaande of nagaande deployment.
Genegeerd. Aanvaard als ruis.


### VOR16a -- 2021-11-29--2021-12-13

Issue: vanaf 2021-12-13 10:30:00, wordt elk beeld één sequentie, en stopt de reeks ook abrupt.

Genegeerd. Aanvaard als ruis. Einddatum van deployment weerspiegelt vroegtijdige stop.

```{r fix VOR16a -- 2021-11-29--2021-12-13}
deployments(raw_data) %>% 
  dplyr::filter(locationName == "VOR16a")

observations(raw_data) %>%
  dplyr::filter(deploymentID == "3ca9d6dd-2dd3-4f68-adf1-316466ea16cf") %>% 
  dplyr::select(deploymentID, eventStart, eventEnd)
```

### VOR15a--VOR18a -- 2021-2022

Issue: niet ingesteld om op de middag en middernacht een foto te nemen.

```{r VOR15a--VOR18a -- 2021-2022}
deployments(raw_data) %>% 
  dplyr::filter(locationName == "VOR15a")

observations(raw_data) %>%
  dplyr::filter(deploymentID == "3ca9d6dd-2dd3-4f68-adf1-316466ea16cf") %>% 
  dplyr::select(deploymentID, eventStart, eventEnd)
```

Geen gevolg nodig.

### BHN13 -- 2022-05-03--2022-05-31

Issue: (1) beeld niet identiek aan deployments vóór storm; (2) beeld niet stabiel tijdens deployment.

Genegeerd. Aanvaard als ruis.

### VOR18a -- 2022-05-03--2022-05-31

Issue: voortijdig uitgevallen, op 2022-05-07.

```{r}
observations(raw_data) %>%
  dplyr::filter(deploymentID == "d0cb880b-8f5d-446b-b558-836eaffc4f31")
```

Geen gevolg nodig.

### INS11 -- 2024-04--2024-05

Issue: problematisch op diverse vlakken.
- Ingesteld op zomer- ipv wintertijd (maar correctie reeds gemaakt in Agouti).
- Aanmaak sequenties foutief (reeksen van 10 zijn vaak opgesplitst).

```{r}
observations(raw_data) %>%
  dplyr::filter(deploymentID == "f22c4374-20e6-4b17-818e-6129d0cd3611")
```

Op 'ongeldig' gezet in Agouti. Kan in theorie nog worden opgeschoond (tijdrovend).

## Inaccurate data that can be fixed

```{r}
clean_data <- raw_data
```


### Fix missassigned observations

Issue: 5 observaties zijn aan verkeerde deployment toegewezen. Behoren toe aan VOR08a i.p.v. BHN12.

```{r show missassigned observations}
observations(clean_data) %>%
  dplyr::filter(observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"")
```

```{r show deploymentID and locationID of these 2 locations}
deployments(clean_data) %>% 
  dplyr::filter(locationName %in% c("VOR08a", "BHN12")) %>% 
  dplyr::select(deploymentID, locationID, locationName)
```


Heeft dit te maken met kleine mismatch in eindtijd van deployment?

M.o.: loont dus om 'Comments' te checken!

```{r fix missassigned observations}
rightdepID <- "38214914-4c0f-485c-91e7-d080d4c5cd0e"

clean_data$observations <-
  camtrapdp::observations(clean_data) %>%
  dplyr::mutate(
    deploymentID = ifelse(
      observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"",
      rightdepID,
      deploymentID
    )
  )

# check if fix is correct
observations(clean_data) %>%
  dplyr::filter(observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"")
```



### Fix BHN13 -- 2022-02--2022-03

Issue: gesneuveld bij storm om 2022-02-18-17-31. Maar is aanvankelijk blijven lopen. DeploymentEnd wordt aangepast, en de observations van na dit moment worden er uit gehaald.

```{r fix BHN13 -- 2022-02--2022-03}
deploymentID_storm <- "f27bd070-d28c-45f0-a888-5b97835bf796"
new_deploymentEnd <- as.POSIXct("2022-02-18 17:31:00", tz = "Europe/Brussels")

clean_data$deployments <-
  camtrapdp::deployments(clean_data) %>%
  dplyr::mutate(
    deploymentEnd =
      as.POSIXct(
        ifelse(
          deploymentID == deploymentID_storm,
          new_deploymentEnd,
          deploymentEnd
        )
      )
  )

# check
deployments(clean_data) %>%
  dplyr::filter(deploymentID == deploymentID_storm) %>%
  dplyr::select(deploymentEnd)

# filter observations and media (based on associated mediaID and eventID)
clean_data <-
  clean_data %>%
  camtrapdp::filter_observations(
    eventEnd <= new_deploymentEnd
  )

# Check if fix is correct
observations(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(
    last_eventEnd = max(eventEnd)
  )
```

### Fix VOR23b -- 2022--2023

Issue: verkeerde tijdsinstelling doorheen campagne. Retroactief bepaald moet die, bij 1ste opstelling, ong. om "2022-12-05 13:40:00" zijn geïnstalleerd (+ 11.87361 uur).

```{r fix VOR23b -- 2022--2023}
wrong_time = "2022-12-05 01:47:35"
right_time = "2022-12-05 13:40:00"

# clean_data <-
#   clean_data %>%
#   camtrapDensity::correct_time(
#     depID = "8de6a0a1-9308-4d99-8a71-e2a2c710739d",
#     wrongTime = wrong_time, rightTime = right_time
#   ) %>%
#   camtrapDensity::correct_time(
#     depID = "c8008e80-3684-4ee0-a491-0e11a7d55918",
#     wrongTime = wrong_time, rightTime = right_time
#   ) %>% 
#   camtrapDensity::correct_time(
#     depID = "83784cd8-107a-4219-82bd-05da22d7abf1",
#     wrongTime = wrong_time, rightTime = right_time) %>% 
#   camtrapDensity::correct_time(
#     depID = "96dc5829-22e9-4532-ba0f-0d891e74051a",
#     wrongTime = wrong_time, rightTime = right_time)
```

### Fix PEE11=INS05 -- 2023--2024

Issue: verkeerde tijdsinstelling doorheen campagne. Retroactief bepaald moet die, bij 1ste opstelling, ong. om "2023-11-21 11:44:00" zijn geïnstalleerd.

```{r fix PEE11-INS05 -- 2023--2024}
wrong = "2023-11-22 00:04:41"
right = "2023-11-21 11:44:00"

# clean_data <-
#   clean_data %>%
#   camtrapDensity::correct_time(
#     depID = "e6f5df99-30a8-4969-b432-eaf88d1d780e",
#     wrongTime = wrong_time, rightTime = right_time
#   ) %>%
#   camtrapDensity::correct_time(
#     depID = "9c94441d-dc0b-4e83-bdee-d4b847b6f003",
#     wrongTime = wrong_time, rightTime = right_time
#   ) %>% 
#   camtrapDensity::correct_time(
#     depID = "71e601db-fbfe-4468-8e40-6cd0d2047a2a",
#     wrongTime = wrong_time, rightTime = right_time
#     ) %>% 
#   camtrapDensity::correct_time(
#     depID = "6acb2575-65f7-411d-b5b1-a8b466127a43",
#     wrongTime = wrong_time, rightTime = right_time)
```

## Inaccurate data that need to be removed

Overview: 

LocationName | Time range | DeploymentID
-- | -- | -- 
HN12 | 2022-02--2022-03 | "7a85b0ea-6ed8-4d1e-801f-78082cb660ec"
VOR08b | 2023-11--2024-01 | "91ae688c-818c-4e74-8c02-8bc2f8c842be"
VOR06b | 2024-02--2024-04 | "72633b07-b39c-4827-ae35-ffcc1cb02607

### BHN12 -- 2022-02--2022-03

Issue: positie van camera sterk verschoven. Kijkt sterk in de lucht. Problematisch.

### VOR08b -- 2023-11--2024-01

Issue: grote tak voor camera gevallen; daar aanwezig van 2023-11-27 tot 2024-01-10.

Dit is nagenoeg de ganse sequentie -> makkelijkst om geheel te verwijderen

### VOR06b -- 2024-02--2024-04

Issue: wel registraties t.e.m. uitlezen, maar klok staat stil vanaf 2024-03-14.

Problematisch. Pro's en cons. -> verstandigst om geheel te verwijderen (?)

### Remove deployments

```{r remove deployments}
deploymentID_to_remove <- c(
  "7a85b0ea-6ed8-4d1e-801f-78082cb660ec",
  "91ae688c-818c-4e74-8c02-8bc2f8c842be",
  "72633b07-b39c-4827-ae35-ffcc1cb02607"
)
clean_data <-
  clean_data %>% 
  camtrapdp::filter_deployments(!deploymentID %in% deploymentID_to_remove)
```


# Filtering

The data should only include observations (and associated media) of animals. Excluded are records that document blank or unclassified media, vehicles and observations of humans. Geospatial coordinates are rounded to 0.001 degrees.

```{r}
# inspection
clean_data %>% 
  camtrapdp::deployments() %>% 
  dplyr::select(latitude, longitude)
clean_data %>%
  camtrapdp::observations() %>% 
  dplyr::select(observationType) %>% 
  unique()

# filtering and rounding
rounded_data <-
  clean_data %>% 
  camtraptor::round_coordinates(digits = 3)

# check
rounded_data %>% 
  camtrapdp::deployments() %>% 
  dplyr::select(latitude, longitude)
```


Exclude dogs (or: include observations but exclude media)
```{r}
rounded_data %>% 
  camtrapdp::filter_observations(scientificName == "Canis lupus familiaris") %>% 
  camtrapdp::media()
```

Correct 'canis lupus' to 'canis lupus familiaris' (preferably upstream in Agouti, obs per obs :-/)

# Transform to a Darwin Core Archive

```{r}
camtrapdp::write_dwc(rounded_data, here("data", "processed", name_exportfolder))
```