---
title: "Clean and filter muntjac dataset"
author: 
- Bram D'hondt
- Sanne Govaert
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r prep packages}
library(here)
library(camtrapdp)
library(dplyr) 
library(lubridate)
```

```{r camtrap data}
name_exportfolder <- "muntjak-vlaanderen-20240606110007"
file <- here::here("data", "raw", name_exportfolder, "datapackage.json")
raw_data <- camtrapdp::read_camtrapdp(file)
```

# Notes on cameras and solutions

## To do: issue that still need a fix

### VOR15b -- 2023-04-06 -- 2023-05-12

Issue: This sequence is from a muntjak, not a calibration. In Agouti (2024-04) the correction cannot be made.

```{r}
seqID <- "f111b060-61cb-4e1f-b47b-e5fab4c3123f" # @Bram is this correct?

deployments(raw_data) %>%
  dplyr::filter(deploymentID == "0427b248-2e3d-4028-b3ce-dc8f5aefbe0c") %>% 
  dplyr::select(deploymentID, locationName, deploymentStart, deploymentEnd)
```

YET TO BE CORRECTED, in Agouti, as soon as possible (24-05-16 still not possible).

## Issues without fix (accept as they are)

### Defects

Cannot be remedied. Accepted as a methodological limitation.

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2021-11 -- 2022-01 | Prematurely failed.
VOR18b | 2022-12 -- 2023-01 | Defective. No sequence obtained.
VOR21b | 2022-12 -- 2023-01 | Defective. No sequence obtained.
PEE01 | 2023-11 -- 2024-01 | Defective. No sequence obtained.
PEE16 | 2024-01 -- 2024-02 | Defective. No sequence obtained.
INS07 | 2024-02 -- 2024-04 | Prematurely failed.
INS12 | 2024-02 -- 2024-04 | Defective. No sequence obtained.
VOR06b | 2024-04-05 -- 2024-04-25 | No camera was installed (none available).
VOR20b | 2024-04 -- 2024-05 | Prematurely failed.
VOR22b | 2024-04 -- 2024-05 | Prematurely failed.
INS12 | 2024-04 -- 2024-05 | Prematurely failed.
INS14 | 2024-04 -- 2024-05 | Prematurely failed.

### Slight image abnormalities

Location | Time range | Comment
-------- | ---------- | -------
VOR16a | 2022-01 -- 2022-02 | Temporary branch for the camera.
VOR16a | 2022-02 -- 2022-03 | Temporary branch for the camera.
VOR16a | 2022-05 -- 2022-05 | Slight shift.
VOR17a | 2021 -- 2022 | Slight shifts throughout the deployment.

Issue: the position of the camera was slightly shifted compared to the previous or subsequent deployment. Ignored. Accepted as noise

### Other issues

Location | Time range | Issue | Conclusion
-------- | ---------- | ----- | ----------
VOR16a | 2021-11-29 -- 2021-12-13 | Each image became a single sequence, and the series also stopped abruptly. | Ignored. Accepted as noise. The end date of the deployment reflects the premature stop.
VOR15a -- VOR18a | 2021 - 2011 | Not set up to take a photo at noon and midnight. | No action required.
BHN13 | 2022-05-03 -- 2022-05-31 | (1) image not identical to deployments before the storm; (2) image not stable during deployment. | Ignored. Accepted as noise.
VOR18a | 2022-05-03 -- 2022-05-31 | Failed prematurely on 2022-05-07. | No action required.
INS11 | 2024-04 -- 2024-05 | Problematic in various aspects. (1) Set to daylight saving time instead of standard time (but the correction has already been made in Agouti); (2) Sequence creation is incorrect (sequences of 10 are often split). | Marked as 'invalid' in Agouti. Could theoretically be cleaned up (time-consuming).

## Inaccurate data that can be fixed

```{r}
clean_data <- raw_data
```

### Fix missassigned observations

Issue: 5 observations have been assigned to the wrong deployment. They belong to VOR08a instead of BHN12.

```{r show missassigned observations}
observations(clean_data) %>%
  dplyr::filter(observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"")
```

```{r show deploymentID and locationID of these 2 locations}
deployments(clean_data) %>% 
  dplyr::filter(locationName %in% c("VOR08a", "BHN12")) %>% 
  dplyr::select(deploymentID, locationID, locationName)
```


Is this related to a small mismatch in the deployment end time?

Suggestion: it's worth checking the 'Comments' section!

```{r fix missassigned observations}
rightdepID <- "38214914-4c0f-485c-91e7-d080d4c5cd0e"

clean_data$observations <-
  camtrapdp::observations(clean_data) %>%
  dplyr::mutate(
    deploymentID = ifelse(
      observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"",
      rightdepID,
      deploymentID
    )
  )

# check if fix is correct
observations(clean_data) %>%
  dplyr::filter(observationComments == "MISASSIGN_CAM=\"Vordenstein_8\"")
```



### Fix BHN13 -- 2022-02--2022-03

Issue: damaged in a storm on 2022-02-18-17-31. But it initially continued to operate.

DeploymentEnd is adjusted, and observations after this time are removed.

```{r fix BHN13 -- 2022-02--2022-03}
deploymentID_storm <- "f27bd070-d28c-45f0-a888-5b97835bf796"
new_deploymentEnd <- as.POSIXct("2022-02-18 17:31:00", tz = "Europe/Brussels")

# Mutate deploymentEnd
clean_data$deployments <-
  camtrapdp::deployments(clean_data) %>%
  dplyr::mutate(
    deploymentEnd =
      as.POSIXct(
        ifelse(
          deploymentID == deploymentID_storm,
          new_deploymentEnd,
          deploymentEnd
        )
      )
  )

# Update observations and media
clean_data <-
  clean_data %>%
  camtrapdp::filter_observations(eventEnd <= new_deploymentEnd)
```

```{r check fix BHN13 -- 2022-02--2022-03}
# Inspect deployment
deployments(clean_data) %>%
  dplyr::filter(deploymentID == deploymentID_storm) %>%
  dplyr::select(deploymentID, deploymentStart, deploymentEnd)

# Inspect observations
observations(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(last_eventEnd = max(eventEnd))

# Inspect media
media(clean_data) %>% 
  dplyr::filter(deploymentID == deploymentID_storm) %>% 
  dplyr::summarise(last_timestamp = max(timestamp))

# Inspect metadata
clean_data$temporal
```

### Fix VOR23b -- 2022--2023

Issue: incorrect time setting throughout the deployment. Retroactively determined, it must have been installed at approximately "2022-12-05 13:40:00" (+ 11.87361 hours) during the initial setup.

```{r fix VOR23b -- 2022--2023}
wrong_time = "2022-12-05 01:47:35"
right_time = "2022-12-05 13:40:00"
duration = lubridate::as.duration(lubridate::interval(wrong_time, right_time))

clean_data <-
  clean_data %>%
  camtrapdp::shift_time(
    deployment_id = "8de6a0a1-9308-4d99-8a71-e2a2c710739d",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "c8008e80-3684-4ee0-a491-0e11a7d55918",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "83784cd8-107a-4219-82bd-05da22d7abf1",
    duration = duration
    ) %>%
  camtrapdp::shift_time(
    deployment_id = "96dc5829-22e9-4532-ba0f-0d891e74051a",
    duration = duration
    )
```

### Fix PEE11=INS05 -- 2023--2024

 Issue: incorrect time setting throughout the deployment. Retroactively determined, it must have been installed at approximately "2023-11-21 11:44:00" during the initial setup.

```{r fix PEE11-INS05 -- 2023--2024}
wrong = "2023-11-22 00:04:41"
right = "2023-11-21 11:44:00"

clean_data <-
  clean_data %>%
  camtrapdp::shift_time(
    deployment_id = "e6f5df99-30a8-4969-b432-eaf88d1d780e",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "9c94441d-dc0b-4e83-bdee-d4b847b6f003",
    duration = duration
  ) %>%
  camtrapdp::shift_time(
    deployment_id = "71e601db-fbfe-4468-8e40-6cd0d2047a2a",
    duration = duration
    ) %>%
  camtrapdp::shift_time(
    deployment_id = "6acb2575-65f7-411d-b5b1-a8b466127a43",
    duration = duration)
```

## Inaccurate data that need to be removed

Overview: 

LocationName | Time range | DeploymentID
-- | -- | -- 
HN12 | 2022-02--2022-03 | "7a85b0ea-6ed8-4d1e-801f-78082cb660ec"
VOR08b | 2023-11--2024-01 | "91ae688c-818c-4e74-8c02-8bc2f8c842be"
VOR06b | 2024-02--2024-04 | "72633b07-b39c-4827-ae35-ffcc1cb02607

### BHN12 -- 2022-02--2022-03

Issue: : The position of the camera has shifted significantly. It is now pointing mostly upwards, which is problematic.

### VOR08b -- 2023-11--2024-01

Issue: A large branch fell in front of the camera; it was there from 2023-11-27 to 2024-01-10.

This is almost the entire sequence, so it would be easiest to remove it completely.

### VOR06b -- 2024-02--2024-04

Issue: Although there were recordings up until the last readout, the clock has stopped since 2024-03-14.

Problematic. Pros and cons. â†’ It would be wisest to remove it completely (?)

### Remove deployments

```{r remove deployments}
deploymentID_to_remove <- c(
  "7a85b0ea-6ed8-4d1e-801f-78082cb660ec",
  "91ae688c-818c-4e74-8c02-8bc2f8c842be",
  "72633b07-b39c-4827-ae35-ffcc1cb02607"
)
clean_data <-
  clean_data %>% 
  camtrapdp::filter_deployments(!deploymentID %in% deploymentID_to_remove)
```


# Filtering

The data should only include observations (and associated media) of animals. Excluded are records that document blank or unclassified media, vehicles and observations of humans. Geospatial coordinates are rounded to 0.001 degrees.

```{r}
# inspection
clean_data %>% 
  camtrapdp::deployments() %>% 
  dplyr::select(latitude, longitude)
clean_data %>%
  camtrapdp::observations() %>% 
  dplyr::select(observationType) %>% 
  unique()

# filtering and rounding
rounded_data <-
  clean_data %>% 
  camtrapdp::round_coordinates(digits = 3)

# check
rounded_data %>% 
  camtrapdp::deployments() %>% 
  dplyr::select(latitude, longitude)
```


Exclude dogs (or: include observations but exclude media)
```{r}
rounded_data %>% 
  camtrapdp::filter_observations(scientificName == "Canis lupus familiaris") %>% 
  camtrapdp::media()
```

Correct 'canis lupus' to 'canis lupus familiaris' (preferably upstream in Agouti, obs per obs :-/)

# Transform to a Darwin Core Archive

```{r}
camtrapdp::write_dwc(rounded_data, here("data", "processed", name_exportfolder))
```